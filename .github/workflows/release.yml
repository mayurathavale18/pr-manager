name: Release

# Trigger on version tags (v1.0.0, v2.3.1, etc.) or manual dispatch.
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write   # needed to create GitHub Releases and upload assets

# ---------------------------------------------------------------------------
# Job 1 – build cross-platform binaries
# ---------------------------------------------------------------------------
jobs:
  build:
    name: Build binary (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest

    strategy:
      # Build all targets even if one fails.
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            archive: tar.gz
          - goos: linux
            goarch: arm64
            archive: tar.gz
          - goos: darwin
            goarch: amd64
            archive: tar.gz
          - goos: darwin
            goarch: arm64
            archive: tar.gz
          - goos: windows
            goarch: amd64
            archive: zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod   # respects the `go` directive in go.mod
          cache: true

      # Determine the version string from the tag; fall back to a dev label.
      - name: Resolve version
        id: ver
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          fi

      # Cross-compile with CGO disabled so the binary is fully static.
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION="${{ steps.ver.outputs.version }}"
          EXT=""
          [ "${{ matrix.goos }}" = "windows" ] && EXT=".exe"

          mkdir -p dist
          go build \
            -ldflags="-X main.Version=${VERSION} -s -w" \
            -trimpath \
            -o "dist/pr-manager${EXT}" \
            ./cmd/pr-manager/

      # Package as .tar.gz for Unix platforms.
      - name: Package (tar.gz)
        if: matrix.archive == 'tar.gz'
        run: |
          VERSION="${{ steps.ver.outputs.version }}"
          ARCHIVE="pr-manager-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz"
          tar -C dist -czf "dist/${ARCHIVE}" pr-manager
          echo "ARCHIVE=${ARCHIVE}" >> "$GITHUB_ENV"

      # Package as .zip for Windows.
      - name: Package (zip)
        if: matrix.archive == 'zip'
        run: |
          VERSION="${{ steps.ver.outputs.version }}"
          ARCHIVE="pr-manager-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.zip"
          cd dist && zip "${ARCHIVE}" pr-manager.exe
          echo "ARCHIVE=${ARCHIVE}" >> "$GITHUB_ENV"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/${{ env.ARCHIVE }}
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Job 2 – build Debian packages (linux only)
  # ---------------------------------------------------------------------------
  package-deb:
    name: Build .deb (${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: build   # wait for the Linux binaries to be uploaded as artifacts

    strategy:
      fail-fast: false
      matrix:
        include:
          - goarch: amd64
            deb_arch: amd64
          - goarch: arm64
            deb_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Resolve version
        id: ver
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
            # Strip leading 'v' for the Debian version field (must start with digit)
            echo "deb_version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=dev" >> "$GITHUB_OUTPUT"
            echo "deb_version=0.0.0~dev" >> "$GITHUB_OUTPUT"
          fi

      # Compile the Go binary targeting this Debian architecture.
      - name: Build binary (linux/${{ matrix.goarch }})
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          mkdir -p dist
          go build \
            -ldflags="-X main.Version=${{ steps.ver.outputs.version }} -s -w" \
            -trimpath \
            -o dist/pr-manager \
            ./cmd/pr-manager/

      - name: Install packaging tools
        run: sudo apt-get update && sudo apt-get install -y fakeroot dpkg-dev

      - name: Assemble and build .deb
        run: |
          VERSION="${{ steps.ver.outputs.deb_version }}"
          DEB_ARCH="${{ matrix.deb_arch }}"
          PKG="pr-manager_${VERSION}_${DEB_ARCH}"

          # Create the Debian staging tree
          mkdir -p "deb/${PKG}/DEBIAN"
          mkdir -p "deb/${PKG}/usr/bin"
          mkdir -p "deb/${PKG}/usr/share/doc/pr-manager"
          mkdir -p "deb/${PKG}/usr/share/man/man1"

          # Binary
          cp dist/pr-manager "deb/${PKG}/usr/bin/pr-manager"
          chmod 755 "deb/${PKG}/usr/bin/pr-manager"

          # Debian maintainer scripts
          cp packaging/debian/DEBIAN/postinst "deb/${PKG}/DEBIAN/"
          cp packaging/debian/DEBIAN/prerm    "deb/${PKG}/DEBIAN/"
          cp packaging/debian/DEBIAN/postrm   "deb/${PKG}/DEBIAN/"
          chmod 755 "deb/${PKG}/DEBIAN/postinst" \
                    "deb/${PKG}/DEBIAN/prerm"    \
                    "deb/${PKG}/DEBIAN/postrm"

          # Documentation
          cp README.md "deb/${PKG}/usr/share/doc/pr-manager/" 2>/dev/null || true
          cp LICENCE   "deb/${PKG}/usr/share/doc/pr-manager/" 2>/dev/null || true

          # Build the control file from the template, substituting version & arch
          sed \
            -e "s/^Version:.*/Version: ${VERSION}/" \
            -e "s/^Architecture:.*/Architecture: ${DEB_ARCH}/" \
            packaging/debian/DEBIAN/control \
            > "deb/${PKG}/DEBIAN/control"

          # Installed-Size (in kibibytes)
          INSTALLED_SIZE=$(du -sk "deb/${PKG}" | awk '{print $1}')
          echo "Installed-Size: ${INSTALLED_SIZE}" >> "deb/${PKG}/DEBIAN/control"

          mkdir -p dist
          fakeroot dpkg-deb --build "deb/${PKG}" "dist/${PKG}.deb"
          dpkg-deb --info "dist/${PKG}.deb"   # quick sanity check

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.goarch }}
          path: dist/*.deb
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Job 3 – create the GitHub Release with all assets
  # ---------------------------------------------------------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, package-deb]
    # Only create a release when we actually pushed a tag.
    if: github.ref_type == 'tag'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Download every artifact from the two previous jobs into dist/
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true   # flatten into dist/ instead of per-job subdirs

      - name: List release assets
        run: ls -lh dist/

      # Copy install.sh into dist/ so it is included as a release asset.
      # This is what makes the /releases/latest/download/install.sh URL work.
      - name: Add install.sh to assets
        run: cp install.sh dist/install.sh

      - name: Generate SHA-256 checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/install.sh
            dist/*.tar.gz
            dist/*.zip
            dist/*.deb
            dist/checksums.txt
          body: |
            ## Installation

            ### One-liner (Linux / macOS)
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/latest/download/install.sh | sh
            ```
            The script detects your OS and architecture, verifies the checksum, and installs
            the binary to `/usr/local/bin` (root) or `~/.local/bin` (non-root).
            Pin a specific version:
            ```bash
            VERSION=${{ github.ref_name }} curl -fsSL https://github.com/${{ github.repository }}/releases/latest/download/install.sh | sh
            ```

            ### Debian / Ubuntu — .deb package
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/pr-manager_${${{ github.ref_name }}#v}_amd64.deb
            sudo dpkg -i pr-manager_*_amd64.deb
            sudo apt-get install -f
            ```

            ### Manual download
            Download the archive for your platform from the assets below, extract, and place
            `pr-manager` on your `PATH`.  Verify with `sha256sum -c checksums.txt`.

            ## Quick start
            ```bash
            pr-manager full 42              # approve + merge PR #42
            pr-manager merge 42 -a -m squash  # auto squash-merge
            pr-manager --help
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
